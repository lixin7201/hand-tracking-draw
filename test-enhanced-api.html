<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•å¢å¼ºç‰ˆ API</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
        }
        .test-btn { 
            padding: 10px 20px; 
            margin: 10px; 
            cursor: pointer; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px;
        }
        .test-btn:hover { 
            background: #45a049; 
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        #results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        img {
            max-width: 100%;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å¢å¼ºç‰ˆ API æµ‹è¯•</h1>
    
    <div>
        <input type="text" id="description" placeholder="è¾“å…¥æè¿° (ä¾‹å¦‚: å°ç‹—ç«™åœ¨å½©è‰²å±±å‰)" style="width: 300px; padding: 10px;">
        <select id="style" style="padding: 10px;">
            <option value="watercolor">æ°´å½©ç”»</option>
            <option value="ghibli" selected>å‰åœåŠ›</option>
            <option value="manga">æ¼«ç”»</option>
            <option value="oil">æ²¹ç”»</option>
            <option value="realistic">å†™å®</option>
        </select>
    </div>
    
    <button class="test-btn" onclick="testFullFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
    <button class="test-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="results">
        <div class="result-section">
            <h3>åŸå§‹ç”»ä½œ</h3>
            <canvas id="testCanvas" width="512" height="512" style="border: 1px solid #ddd;"></canvas>
        </div>
        <div class="result-section">
            <h3>AI ç”Ÿæˆç»“æœ</h3>
            <div id="aiResult"></div>
        </div>
    </div>
    
    <div id="log"></div>

    <script>
        // åˆå§‹åŒ–ç”»å¸ƒ
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        
        function drawTestImage() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 512, 512);
            
            // ç”»å¤©ç©º
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, 512, 200);
            
            // ç”»å½©è‰²çš„å±±ï¼ˆä¸‰åº§ï¼‰
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1'];
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = colors[i];
                ctx.beginPath();
                ctx.moveTo(100 + i * 120, 200);
                ctx.lineTo(170 + i * 120, 100);
                ctx.lineTo(240 + i * 120, 200);
                ctx.closePath();
                ctx.fill();
            }
            
            // ç”»è‰åœ°
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, 200, 512, 312);
            
            // ç”»å°ç‹—ï¼ˆç®€å•ç‰ˆï¼‰
            ctx.fillStyle = '#8B4513';
            // èº«ä½“
            ctx.beginPath();
            ctx.ellipse(256, 350, 60, 40, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // å¤´
            ctx.beginPath();
            ctx.arc(256, 320, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // è…¿
            ctx.fillRect(230, 370, 10, 30);
            ctx.fillRect(250, 370, 10, 30);
            ctx.fillRect(270, 370, 10, 30);
            ctx.fillRect(290, 370, 10, 30);
            
            // è€³æœµ
            ctx.beginPath();
            ctx.ellipse(240, 310, 8, 15, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(272, 310, 8, 15, 0.3, 0, Math.PI * 2);
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(245, 320, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(267, 320, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // é¼»å­
            ctx.beginPath();
            ctx.arc(256, 330, 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // åˆå§‹åŒ–æ—¶ç”»ä¸€ä¸ªæµ‹è¯•å›¾
        drawTestImage();
        
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('aiResult').innerHTML = '';
        }

        async function testFullFlow() {
            try {
                clearLogs();
                log('========== å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹ ==========', 'info');
                
                const description = document.getElementById('description').value || 'å°ç‹—ç«™åœ¨å½©è‰²å±±å‰';
                const style = document.getElementById('style').value;
                
                log(`ç”¨æˆ·æè¿°: "${description}"`, 'info');
                log(`é€‰æ‹©é£æ ¼: ${style}`, 'info');
                
                // è·å–ç”»å¸ƒå›¾ç‰‡
                const imageDataUrl = canvas.toDataURL('image/png');
                log(`å›¾ç‰‡æ•°æ®å‡†å¤‡å®Œæˆ (${imageDataUrl.length} å­—ç¬¦)`, 'info');
                
                // Step 1: åˆ†ææ¶‚é¸¦
                log('\nğŸ“ Step 1: åˆ†ææ¶‚é¸¦å†…å®¹...', 'info');
                
                const base64Data = imageDataUrl.split(',')[1];
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                const blob = new Blob([bytes], { type: 'image/png' });
                const formData = new FormData();
                formData.append('image', blob, 'test.png');
                formData.append('description', description);
                
                const analyzeResp = await fetch('http://localhost:3001/api/analyze-doodle', {
                    method: 'POST',
                    body: formData
                });
                
                const analyzeData = await analyzeResp.json();
                
                if (analyzeData.success) {
                    log(`âœ… åˆ†ææˆåŠŸ!`, 'success');
                    log(`åˆ†æç»“æœ (${analyzeData.analysis.length} å­—ç¬¦):`, 'info');
                    log(analyzeData.analysis, 'info');
                } else {
                    log(`âŒ åˆ†æå¤±è´¥: ${analyzeData.error}`, 'error');
                    return;
                }
                
                // Step 2: ç”Ÿæˆæç¤ºè¯
                log('\nğŸ¨ Step 2: ç”Ÿæˆ Flux æç¤ºè¯...', 'info');
                
                const promptResp = await fetch('http://localhost:3001/api/generate-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis: analyzeData.analysis,
                        style: style,
                        imageDataUrl: imageDataUrl
                    })
                });
                
                const promptData = await promptResp.json();
                
                if (promptData.success) {
                    log(`âœ… æç¤ºè¯ç”ŸæˆæˆåŠŸ!`, 'success');
                    log(`è‹±æ–‡æç¤ºè¯:`, 'info');
                    log(promptData.prompt, 'success');
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡
                    const hasChinese = /[\u4e00-\u9fa5]/.test(promptData.prompt);
                    if (hasChinese) {
                        log('âš ï¸ è­¦å‘Š: æç¤ºè¯åŒ…å«ä¸­æ–‡å­—ç¬¦!', 'warning');
                    } else {
                        log('âœ… æç¤ºè¯ä¸ºçº¯è‹±æ–‡', 'success');
                    }
                } else {
                    log(`âŒ æç¤ºè¯ç”Ÿæˆå¤±è´¥: ${promptData.error}`, 'error');
                    return;
                }
                
                // Step 3: ç”Ÿæˆè‰ºæœ¯ç”»
                log('\nğŸ–¼ï¸ Step 3: ç”Ÿæˆè‰ºæœ¯ç”»ä½œ (éœ€è¦ 30-60 ç§’)...', 'info');
                
                const artResp = await fetch('http://localhost:3001/api/generate-art', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: promptData.prompt,
                        imageUrl: imageDataUrl,
                        promptStrength: 0.8,
                        aspectRatio: '1:1'
                    })
                });
                
                const artData = await artResp.json();
                
                if (artData.success) {
                    log(`âœ… è‰ºæœ¯ç”»ç”ŸæˆæˆåŠŸ!`, 'success');
                    
                    if (artData.imageUrl.startsWith('http')) {
                        log(`å›¾ç‰‡ URL: ${artData.imageUrl}`, 'success');
                        
                        // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                        const resultDiv = document.getElementById('aiResult');
                        resultDiv.innerHTML = `
                            <img src="${artData.imageUrl}" alt="AI Generated Art">
                            <p><a href="${artData.imageUrl}" target="_blank">åœ¨æ–°çª—å£æ‰“å¼€</a></p>
                        `;
                    } else {
                        log(`ç”Ÿæˆäº†æœ¬åœ°å›¾ç‰‡`, 'info');
                    }
                    
                    log('\n========== æµ‹è¯•å®Œæˆ ==========', 'success');
                } else {
                    log(`âŒ è‰ºæœ¯ç”»ç”Ÿæˆå¤±è´¥: ${artData.error}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>