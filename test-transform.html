<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè½¬ç”»åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .canvas-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        canvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
        }
        
        .status {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .result-display {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .result-item {
            text-align: center;
        }
        
        .result-item img {
            max-width: 400px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        select, textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 100%;
            max-width: 300px;
        }
        
        .test-log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            color: green;
            font-weight: bold;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
        
        .warning {
            color: orange;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ AIè½¬ç”»åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>1. ç»˜åˆ¶æµ‹è¯•æ¶‚é¸¦</h2>
        <p>åœ¨ä¸‹é¢çš„ç”»å¸ƒä¸Šç»˜åˆ¶ç®€å•çš„æ¶‚é¸¦ç”¨äºæµ‹è¯•</p>
        <div class="canvas-container">
            <canvas id="testCanvas" width="400" height="400"></canvas>
        </div>
        <div class="test-controls">
            <button onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
            <button onclick="drawTestDoodle()">ç”Ÿæˆæµ‹è¯•æ¶‚é¸¦</button>
            <button onclick="loadSampleImage()">åŠ è½½ç¤ºä¾‹å›¾ç‰‡</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2. APIæµ‹è¯•</h2>
        
        <div style="margin: 15px 0;">
            <label>é€‰æ‹©è‰ºæœ¯é£æ ¼ï¼š</label>
            <select id="styleSelect">
                <option value="watercolor">æ°´å½©ç”»</option>
                <option value="ghibli">å‰åœåŠ›</option>
                <option value="manga">æ¼«ç”»</option>
                <option value="oil">æ²¹ç”»</option>
                <option value="realistic">å†™å®</option>
            </select>
        </div>
        
        <div style="margin: 15px 0;">
            <label>æ¶‚é¸¦æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <textarea id="descriptionInput" rows="3" placeholder="æè¿°ä½ çš„æ¶‚é¸¦å†…å®¹..."></textarea>
        </div>
        
        <div class="test-controls">
            <button onclick="testGeminiAPI()">æµ‹è¯•Geminiåˆ†æ</button>
            <button onclick="testFluxPrompt()">æµ‹è¯•æç¤ºè¯ç”Ÿæˆ</button>
            <button onclick="testFullTransform()">å®Œæ•´è½¬æ¢æµ‹è¯•</button>
        </div>
        
        <div class="status" id="testStatus">
            æµ‹è¯•çŠ¶æ€å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
        </div>
    </div>
    
    <div class="test-section">
        <h2>3. æµ‹è¯•ç»“æœ</h2>
        <div id="resultContainer" class="result-display">
            <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div class="test-log" id="testLog">
            æµ‹è¯•æ—¥å¿—...
        </div>
    </div>
    
    <script src="ai-transform.js"></script>
    <script>
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // é¼ æ ‡ç»˜åˆ¶äº‹ä»¶
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            log('ç”»å¸ƒå·²æ¸…ç©º', 'success');
        }
        
        // ç”Ÿæˆæµ‹è¯•æ¶‚é¸¦
        function drawTestDoodle() {
            clearCanvas();
            
            // ç”»ä¸€ä¸ªç®€å•çš„ç¬‘è„¸
            ctx.strokeStyle = '#FFD700';
            ctx.fillStyle = '#FFD700';
            ctx.lineWidth = 3;
            
            // è„¸
            ctx.beginPath();
            ctx.arc(200, 200, 100, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(170, 180, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(230, 180, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // å˜´å·´
            ctx.strokeStyle = '#000000';
            ctx.beginPath();
            ctx.arc(200, 210, 40, 0, Math.PI);
            ctx.stroke();
            
            // æ·»åŠ ä¸€äº›æ¶‚é¸¦å…ƒç´ 
            ctx.strokeStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(50, 50);
            ctx.lineTo(80, 90);
            ctx.lineTo(40, 90);
            ctx.closePath();
            ctx.stroke();
            
            ctx.strokeStyle = '#4ECDC4';
            ctx.beginPath();
            ctx.rect(320, 50, 50, 50);
            ctx.stroke();
            
            log('æµ‹è¯•æ¶‚é¸¦å·²ç”Ÿæˆ', 'success');
        }
        
        // åŠ è½½ç¤ºä¾‹å›¾ç‰‡
        function loadSampleImage() {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                log('ç¤ºä¾‹å›¾ç‰‡å·²åŠ è½½', 'success');
            };
            img.onerror = function() {
                log('ç¤ºä¾‹å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                drawTestDoodle();
            };
            // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ•°æ®URLä½œä¸ºç¤ºä¾‹
            img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
        }
        
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // åŒæ—¶æ›´æ–°çŠ¶æ€
            const statusDiv = document.getElementById('testStatus');
            statusDiv.innerHTML = `æœ€æ–°çŠ¶æ€: ${message}`;
        }
        
        // æµ‹è¯•Gemini API
        async function testGeminiAPI() {
            log('å¼€å§‹æµ‹è¯•Gemini API...');
            
            try {
                const imageDataUrl = canvas.toDataURL('image/png');
                const description = document.getElementById('descriptionInput').value;
                
                log('æ­£åœ¨åˆ†ææ¶‚é¸¦å†…å®¹...');
                const analysis = await window.ArtTransform.analyzeDoodleContent(imageDataUrl, description);
                
                log('Geminiåˆ†ææˆåŠŸï¼', 'success');
                log('åˆ†æç»“æœ: ' + analysis);
                
                return analysis;
            } catch (error) {
                log('Gemini APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // æµ‹è¯•Fluxæç¤ºè¯ç”Ÿæˆ
        async function testFluxPrompt() {
            log('å¼€å§‹æµ‹è¯•Fluxæç¤ºè¯ç”Ÿæˆ...');
            
            try {
                const imageDataUrl = canvas.toDataURL('image/png');
                const style = document.getElementById('styleSelect').value;
                
                // å…ˆè¿›è¡Œåˆ†æ
                const analysis = await testGeminiAPI();
                if (!analysis) return;
                
                log('æ­£åœ¨ç”ŸæˆFluxæç¤ºè¯...');
                const prompt = await window.ArtTransform.generateFluxPrompt(analysis, style, imageDataUrl);
                
                log('æç¤ºè¯ç”ŸæˆæˆåŠŸï¼', 'success');
                log('ç”Ÿæˆçš„æç¤ºè¯: ' + prompt);
                
                return prompt;
            } catch (error) {
                log('Fluxæç¤ºè¯ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // å®Œæ•´è½¬æ¢æµ‹è¯•
        async function testFullTransform() {
            log('å¼€å§‹å®Œæ•´è½¬æ¢æµ‹è¯•...');
            
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = '<p>æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</p>';
            
            try {
                const style = document.getElementById('styleSelect').value;
                const description = document.getElementById('descriptionInput').value;
                
                const result = await window.ArtTransform.transformDoodleToArt(
                    canvas,
                    style,
                    description,
                    (status) => {
                        log('è¿›åº¦: ' + status);
                    }
                );
                
                log('è½¬æ¢æˆåŠŸï¼', 'success');
                log('åˆ†æ: ' + result.analysis);
                log('æç¤ºè¯: ' + result.prompt);
                
                // æ˜¾ç¤ºç»“æœ
                resultContainer.innerHTML = `
                    <div class="result-item">
                        <h3>åŸå§‹æ¶‚é¸¦</h3>
                        <img src="${result.originalImage}" alt="åŸå§‹æ¶‚é¸¦">
                    </div>
                    <div class="result-item">
                        <h3>${result.style}é£æ ¼</h3>
                        <img src="${result.artworkUrl}" alt="è½¬æ¢åçš„è‰ºæœ¯ä½œå“">
                    </div>
                `;
                
            } catch (error) {
                log('å®Œæ•´è½¬æ¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                console.error(error);
                resultContainer.innerHTML = '<p style="color: red;">è½¬æ¢å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…</p>';
            }
        }
        
        // åˆå§‹åŒ–
        initCanvas();
        drawTestDoodle();
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
    </script>
</body>
</html>