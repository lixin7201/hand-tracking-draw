<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè½¬ç”»åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #666;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .images {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .image-container {
            flex: 1;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ AIè½¬ç”»åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æµ‹è¯•APIä»£ç†æœåŠ¡å™¨</h2>
            <button onclick="testProxyHealth()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
            <div id="proxy-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. åˆ›å»ºæµ‹è¯•æ¶‚é¸¦</h2>
            <canvas id="testCanvas" width="400" height="400"></canvas>
            <br>
            <button onclick="drawTestDoodle()">ç»˜åˆ¶æµ‹è¯•æ¶‚é¸¦</button>
            <button onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
        </div>

        <div class="test-section">
            <h2>3. æµ‹è¯•Geminiåˆ†æ</h2>
            <button onclick="testGeminiAnalysis()">åˆ†ææ¶‚é¸¦å†…å®¹</button>
            <div id="gemini-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. æµ‹è¯•å®Œæ•´AIè½¬æ¢</h2>
            <select id="styleSelect">
                <option value="watercolor">æ°´å½©ç”»</option>
                <option value="ghibli">å‰åœåŠ›</option>
                <option value="manga">æ¼«ç”»</option>
                <option value="oil">æ²¹ç”»</option>
                <option value="realistic">å†™å®</option>
            </select>
            <button onclick="testFullTransform()">å¼€å§‹AIè½¬æ¢</button>
            <div id="transform-result" class="result"></div>
            <div class="images">
                <div class="image-container">
                    <h3>åŸå§‹æ¶‚é¸¦</h3>
                    <img id="originalImage" style="display:none">
                </div>
                <div class="image-container">
                    <h3>AIè‰ºæœ¯ç”»</h3>
                    <img id="artworkImage" style="display:none">
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½AIè½¬æ¢æ¨¡å— -->
    <script src="ai-transform.js"></script>
    
    <script>
        // åˆå§‹åŒ–ç”»å¸ƒ
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        
        // ç»˜åˆ¶æµ‹è¯•æ¶‚é¸¦
        function drawTestDoodle() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å¤ªé˜³
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(320, 80, 40, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶è‰åœ°
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, 300, 400, 100);
            
            // ç»˜åˆ¶æˆ¿å­
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(150, 200, 100, 100);
            
            // ç»˜åˆ¶å±‹é¡¶
            ctx.fillStyle = '#DC143C';
            ctx.beginPath();
            ctx.moveTo(130, 200);
            ctx.lineTo(200, 150);
            ctx.lineTo(270, 200);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶é—¨
            ctx.fillStyle = '#654321';
            ctx.fillRect(180, 250, 40, 50);
            
            // ç»˜åˆ¶çª—æˆ·
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(160, 220, 30, 30);
            ctx.fillRect(210, 220, 30, 30);
            
            // ç»˜åˆ¶æ ‘
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(50, 250, 20, 50);
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.arc(60, 230, 35, 0, Math.PI * 2);
            ctx.fill();
            
            console.log('æµ‹è¯•æ¶‚é¸¦å·²ç»˜åˆ¶');
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // æµ‹è¯•ä»£ç†æœåŠ¡å™¨å¥åº·çŠ¶æ€
        async function testProxyHealth() {
            const resultDiv = document.getElementById('proxy-result');
            resultDiv.innerHTML = '<span class="loading">æ£€æŸ¥ä¸­...</span>';
            
            try {
                const response = await fetch('http://localhost:3001/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    resultDiv.innerHTML = `<span class="success">âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸\n${JSON.stringify(data, null, 2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}</span>`;
            }
        }
        
        // æµ‹è¯•Geminiåˆ†æ
        async function testGeminiAnalysis() {
            const resultDiv = document.getElementById('gemini-result');
            resultDiv.innerHTML = '<span class="loading">åˆ†æä¸­...</span>';
            
            try {
                const imageDataUrl = canvas.toDataURL('image/png');
                const analysis = await window.ArtTransform.analyzeDoodleContent(
                    imageDataUrl, 
                    'è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æˆ¿å­å’Œæ ‘çš„æ¶‚é¸¦'
                );
                
                resultDiv.innerHTML = `<span class="success">âœ… åˆ†ææˆåŠŸ:\n${analysis}</span>`;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ åˆ†æå¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // æµ‹è¯•å®Œæ•´è½¬æ¢
        async function testFullTransform() {
            const resultDiv = document.getElementById('transform-result');
            const style = document.getElementById('styleSelect').value;
            const originalImg = document.getElementById('originalImage');
            const artworkImg = document.getElementById('artworkImage');
            
            // éšè—ä¹‹å‰çš„å›¾ç‰‡
            originalImg.style.display = 'none';
            artworkImg.style.display = 'none';
            
            resultDiv.innerHTML = '<span class="loading">è½¬æ¢ä¸­ï¼Œè¯·ç¨å€™...</span>';
            
            try {
                const result = await window.ArtTransform.transformDoodleToArt(
                    canvas,
                    style,
                    'å„¿ç«¥ç”»çš„æˆ¿å­å’Œæ ‘',
                    (progress) => {
                        resultDiv.innerHTML = `<span class="loading">${progress}</span>`;
                    }
                );
                
                // æ˜¾ç¤ºç»“æœ
                resultDiv.innerHTML = `<span class="success">âœ… è½¬æ¢æˆåŠŸ!\né£æ ¼: ${result.style}\nåˆ†æ: ${result.analysis}\næç¤ºè¯: ${result.prompt}</span>`;
                
                // æ˜¾ç¤ºå›¾ç‰‡
                originalImg.src = result.originalImage;
                originalImg.style.display = 'block';
                
                artworkImg.src = result.artworkUrl;
                artworkImg.style.display = 'block';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ è½¬æ¢å¤±è´¥: ${error.message}</span>`;
                console.error('Transform error:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ç»˜åˆ¶æµ‹è¯•æ¶‚é¸¦
        window.onload = () => {
            drawTestDoodle();
        };
    </script>
</body>
</html>