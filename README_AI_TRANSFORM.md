# AI涂鸦转画功能说明文档

## 功能概述

本项目新增了AI涂鸦转画功能，可以将儿童的简单涂鸦转换成不同艺术风格的精美画作。

### 支持的艺术风格
- 🎨 **水彩画** - 柔和的水彩风格
- 🏞️ **吉卜力** - 宫崎骏动画风格  
- 📚 **漫画** - 日本漫画风格
- 🖼️ **油画** - 经典油画风格
- 📷 **写实** - 真实照片风格

## 技术架构

### 核心组件
1. **ai-transform.js** - AI转换核心模块
2. **api-proxy.js** - API代理服务器（可选）
3. **UI组件** - 集成在主应用中的用户界面

### API集成
- **Gemini API** (通过OpenRouter) - 用于分析涂鸦内容和生成提示词
- **Flux API** (Replicate) - 用于生成最终的艺术画作

## 使用方法

### 1. 直接使用（前端模式）

无需额外配置，直接在浏览器中使用：

1. 打开应用，绘制涂鸦
2. 点击"AI转画"按钮
3. 选择艺术风格
4. （可选）输入涂鸦描述
5. 点击"开始转换"
6. 等待AI处理完成
7. 查看并保存结果

### 2. 使用API代理服务器（推荐用于生产环境）

#### 安装依赖
```bash
npm run install-api
# 或者
npm install express cors multer node-fetch@2 form-data
```

#### 启动API代理服务器
```bash
npm run api
# 服务器将在 http://localhost:3001 启动
```

#### 配置前端使用代理
编辑 `ai-transform.js`，修改配置：
```javascript
const API_CONFIG = {
    useProxy: true,  // 设置为 true
    proxyUrl: 'http://localhost:3001',  // 代理服务器地址
    // ...
};
```

## 工作流程

### 转换流程
1. **图像准备** - 将画布内容转换为图像数据
2. **内容分析** - Gemini分析涂鸦内容，理解画面元素
3. **提示词生成** - 根据选择的风格生成Flux提示词
4. **艺术创作** - Flux根据原图和提示词生成艺术画作
5. **结果展示** - 显示原图和转换后的对比

### API调用流程
```
用户涂鸦 
    ↓
Gemini API (分析内容)
    ↓
Gemini API (生成提示词) 
    ↓
Flux API (生成艺术画)
    ↓
展示结果
```

## 测试

### 运行测试页面
```bash
# 启动本地服务器
npm start

# 在浏览器中打开
http://localhost:3000/test-transform.html
```

### 测试功能
- 绘制测试涂鸦
- 测试Gemini API连接
- 测试Flux提示词生成
- 完整转换流程测试

## 部署说明

### Vercel部署
1. 项目已配置好`vercel.json`
2. 直接部署静态文件即可
3. API密钥已内置（生产环境建议使用环境变量）

### 使用API代理服务器部署
1. 部署Node.js应用（api-proxy.js）
2. 设置环境变量：
   ```bash
   OPENROUTER_API_KEY=your_key_here
   REPLICATE_API_KEY=your_key_here
   PORT=3001
   ```
3. 更新前端配置指向代理服务器

## API密钥管理

### 当前配置（开发用）
- OpenRouter API Key: `sk-or-v1-e695...`
- Replicate API Key: `r8_17QffuC...`

### 生产环境建议
1. 使用环境变量存储API密钥
2. 部署API代理服务器
3. 实施请求限流和认证
4. 监控API使用量

## 注意事项

### 图像存储
- 当前使用Data URL传输图像
- 生产环境建议使用云存储服务（如AWS S3、Cloudinary）
- 需要实现`uploadToPublicStorage`函数以支持Flux API

### CORS问题
- 直接调用API可能遇到CORS限制
- 建议使用API代理服务器解决
- 或配置适当的CORS headers

### 性能优化
- 大图像可能导致处理缓慢
- 建议限制画布尺寸或压缩图像
- 实施缓存机制避免重复调用

### 错误处理
- API调用可能失败（网络、限流等）
- 已实现基本错误处理和用户提示
- 建议添加重试机制

## 费用说明

### API使用费用
- Gemini API: 按token计费
- Flux API: 按生成次数计费
- 请监控使用量避免超支

### 优化建议
- 缓存常见转换结果
- 限制每用户调用频率
- 提供预览功能减少完整转换

## 扩展功能建议

1. **批量处理** - 支持多张涂鸦批量转换
2. **历史记录** - 保存转换历史供查看
3. **分享功能** - 生成分享链接或社交媒体集成
4. **更多风格** - 添加更多艺术风格选项
5. **参数调节** - 允许用户调整转换强度等参数
6. **实时预览** - 提供低分辨率快速预览

## 故障排除

### 常见问题

1. **转换失败**
   - 检查网络连接
   - 验证API密钥是否有效
   - 查看浏览器控制台错误信息

2. **图像无法显示**
   - 检查图像URL是否可访问
   - 确认CORS设置正确

3. **API代理无法启动**
   - 确认端口未被占用
   - 检查Node.js版本（需要14+）
   - 验证依赖安装完整

## 联系支持

如有问题或建议，请联系开发团队。

---
*版本：1.0.0*
*更新日期：2025年1月*